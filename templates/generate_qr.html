<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Generator | Attendance System</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#667eea">
    
    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .generator-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin: 2rem auto;
            max-width: 600px;
        }

        .generator-title {
            text-align: center;
            color: #2c3e50;
            font-weight: 700;
            margin-bottom: 2rem;
        }

        .qr-display {
            text-align: center;
            margin: 2rem 0;
            padding: 2rem;
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px dashed #dee2e6;
        }

        #qr-canvas {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .form-control, .form-select {
            border-radius: 12px;
            border: 2px solid #e9ecef;
            padding: 0.75rem;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .btn-generator {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            color: white;
            transition: all 0.3s ease;
        }

        .btn-generator:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
            color: white;
        }

        .btn-outline-generator {
            border: 2px solid #667eea;
            color: #667eea;
            background: transparent;
            border-radius: 12px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-outline-generator:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .student-list {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .student-item:hover {
            background-color: rgba(102, 126, 234, 0.1);
        }

        .student-item:last-child {
            border-bottom: none;
        }

        .student-info {
            flex-grow: 1;
        }

        .student-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .student-details {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .qr-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin: 1.5rem 0;
        }

        .bulk-actions {
            background: #e3f2fd;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        @media (max-width: 768px) {
            .generator-container {
                margin: 1rem;
                padding: 1.5rem;
            }
            
            .qr-actions {
                flex-direction: column;
                align-items: center;
            }
            
            .btn-generator,
            .btn-outline-generator {
                width: 100%;
                max-width: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="generator-container">
            <h2 class="generator-title">
                <i class="fas fa-qrcode"></i>
                QR Code Generator
            </h2>

            <!-- Generation Type Selection -->
            <div class="mb-4">
                <label class="form-label fw-bold">Generation Type:</label>
                <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="genType" id="single" value="single" checked>
                    <label class="btn btn-outline-generator" for="single">Single Student</label>
                    
                    <input type="radio" class="btn-check" name="genType" id="bulk" value="bulk">
                    <label class="btn btn-outline-generator" for="bulk">Bulk Generate</label>
                    
                    <input type="radio" class="btn-check" name="genType" id="custom" value="custom">
                    <label class="btn btn-outline-generator" for="custom">Custom Code</label>
                </div>
            </div>

            <!-- Single Student Generation -->
            <div id="single-section">
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label for="student-select" class="form-label">
                            <i class="fas fa-user me-1"></i> Select Student
                        </label>
                        <select class="form-select" id="student-select">
                            <option value="">Choose a student...</option>
                            <!-- Students will be populated dynamically -->
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="qr-type" class="form-label">
                            <i class="fas fa-cog me-1"></i> QR Type
                        </label>
                        <select class="form-select" id="qr-type">
                            <option value="attendance">Attendance</option>
                            <option value="identification">ID Card</option>
                            <option value="access">Access Control</option>
                        </select>
                    </div>
                </div>

                <div class="text-center">
                    <button class="btn-generator" onclick="generateSingleQR()">
                        <i class="fas fa-magic me-2"></i>Generate QR Code
                    </button>
                </div>
            </div>

            <!-- Bulk Generation -->
            <div id="bulk-section" style="display: none;">
                <div class="bulk-actions">
                    <h5><i class="fas fa-users me-2"></i>Bulk Generation Options</h5>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <select class="form-select" id="bulk-department">
                                <option value="">All Departments</option>
                                <option value="Computer">Computer</option>
                                <option value="Electrical">Electrical</option>
                                <option value="Civil">Civil</option>
                                <option value="ENTC">ENTC</option>
                                <option value="Instrumentation">Instrumentation</option>
                                <option value="Mechanical">Mechanical</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <select class="form-select" id="bulk-year">
                                <option value="">All Years</option>
                                <option value="1st Year">First Year</option>
                                <option value="2nd Year">Second Year</option>
                                <option value="3rd Year">Third Year</option>
                                <option value="4th Year">Final Year</option>
                            </select>
                        </div>
                    </div>
                    <div class="text-center mt-3">
                        <button class="btn-generator" onclick="generateBulkQR()">
                            <i class="fas fa-download me-2"></i>Generate & Download ZIP
                        </button>
                    </div>
                </div>

                <!-- Student List for Bulk -->
                <div class="student-list" id="student-list">
                    <!-- Students will be populated here -->
                </div>
            </div>

            <!-- Custom Code Generation -->
            <div id="custom-section" style="display: none;">
                <div class="mb-3">
                    <label for="custom-data" class="form-label">
                        <i class="fas fa-keyboard me-1"></i> Custom Data
                    </label>
                    <textarea class="form-control" id="custom-data" rows="3" 
                              placeholder="Enter custom data for QR code"></textarea>
                </div>
                <div class="text-center">
                    <button class="btn-generator" onclick="generateCustomQR()">
                        <i class="fas fa-code me-2"></i>Generate Custom QR
                    </button>
                </div>
            </div>

            <!-- QR Code Display -->
            <div class="qr-display" id="qr-display" style="display: none;">
                <canvas id="qr-canvas"></canvas>
                <div class="mt-3">
                    <strong id="qr-info"></strong>
                </div>
            </div>

            <!-- QR Actions -->
            <div class="qr-actions" id="qr-actions" style="display: none;">
                <button class="btn-outline-generator" onclick="downloadQR()">
                    <i class="fas fa-download me-2"></i>Download PNG
                </button>
                <button class="btn-outline-generator" onclick="printQR()">
                    <i class="fas fa-print me-2"></i>Print
                </button>
                <button class="btn-outline-generator" onclick="shareQR()">
                    <i class="fas fa-share me-2"></i>Share
                </button>
            </div>

            <!-- Navigation -->
            <div class="text-center mt-4">
                <a href="{{ url_for('qr_scanner') }}" class="btn-outline-generator me-2">
                    <i class="fas fa-camera me-2"></i>QR Scanner
                </a>
                <a href="{{ url_for('home') }}" class="btn-outline-generator">
                    <i class="fas fa-home me-2"></i>Home
                </a>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentQRData = null;
        let students = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadStudents();
            setupEventListeners();
        });

        // Setup event listeners
        function setupEventListeners() {
            document.querySelectorAll('input[name="genType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    showSection(this.value);
                });
            });

            document.getElementById('bulk-department').addEventListener('change', filterStudents);
            document.getElementById('bulk-year').addEventListener('change', filterStudents);
        }

        // Show appropriate section
        function showSection(type) {
            document.getElementById('single-section').style.display = type === 'single' ? 'block' : 'none';
            document.getElementById('bulk-section').style.display = type === 'bulk' ? 'block' : 'none';
            document.getElementById('custom-section').style.display = type === 'custom' ? 'block' : 'none';
            
            if (type === 'bulk') {
                loadStudentList();
            }
        }

        // Load students from server
        async function loadStudents() {
            try {
                const response = await fetch('/api/students');
                students = await response.json();
                populateStudentSelect();
                if (document.querySelector('input[name="genType"]:checked').value === 'bulk') {
                    loadStudentList();
                }
            } catch (error) {
                console.error('Failed to load students:', error);
            }
        }

        // Populate student select dropdown
        function populateStudentSelect() {
            const select = document.getElementById('student-select');
            select.innerHTML = '<option value="">Choose a student...</option>';
            
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.name} (${student.student_id}) - ${student.department}`;
                select.appendChild(option);
            });
        }

        // Load student list for bulk generation
        function loadStudentList() {
            const container = document.getElementById('student-list');
            container.innerHTML = '';
            
            const filteredStudents = getFilteredStudents();
            
            filteredStudents.forEach(student => {
                const item = document.createElement('div');
                item.className = 'student-item';
                item.innerHTML = `
                    <div class="student-info">
                        <div class="student-name">${student.name}</div>
                        <div class="student-details">${student.student_id} • ${student.department} • ${student.class_year}</div>
                    </div>
                    <div>
                        <input class="form-check-input" type="checkbox" value="${student.id}" checked>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        // Filter students based on department and year
        function filterStudents() {
            loadStudentList();
        }

        // Get filtered students
        function getFilteredStudents() {
            const department = document.getElementById('bulk-department').value;
            const year = document.getElementById('bulk-year').value;
            
            return students.filter(student => {
                const deptMatch = !department || student.department === department;
                const yearMatch = !year || student.class_year === year;
                return deptMatch && yearMatch;
            });
        }

        // Generate single QR code
        async function generateSingleQR() {
            const studentId = document.getElementById('student-select').value;
            const qrType = document.getElementById('qr-type').value;
            
            if (!studentId) {
                alert('Please select a student');
                return;
            }

            const student = students.find(s => s.id == studentId);
            if (!student) {
                alert('Student not found');
                return;
            }

            const qrData = {
                type: qrType,
                student_id: student.student_id,
                name: student.name,
                id: student.id,
                timestamp: new Date().toISOString()
            };

            generateQRCode(JSON.stringify(qrData), `${student.name} - ${qrType.toUpperCase()}`);
        }

        // Generate bulk QR codes
        async function generateBulkQR() {
            const selectedStudents = [];
            document.querySelectorAll('#student-list input[type="checkbox"]:checked').forEach(checkbox => {
                const student = students.find(s => s.id == checkbox.value);
                if (student) selectedStudents.push(student);
            });

            if (selectedStudents.length === 0) {
                alert('Please select at least one student');
                return;
            }

            // Generate ZIP file with all QR codes
            const zip = new JSZip();
            const qrPromises = [];

            for (const student of selectedStudents) {
                const qrData = {
                    type: 'attendance',
                    student_id: student.student_id,
                    name: student.name,
                    id: student.id,
                    timestamp: new Date().toISOString()
                };

                const promise = QRCode.toDataURL(JSON.stringify(qrData), {
                    width: 300,
                    margin: 2,
                    color: {
                        dark: '#000000',
                        light: '#FFFFFF'
                    }
                }).then(dataUrl => {
                    const base64Data = dataUrl.split(',')[1];
                    zip.file(`${student.student_id}_${student.name.replace(/\s+/g, '_')}.png`, base64Data, {base64: true});
                });

                qrPromises.push(promise);
            }

            try {
                await Promise.all(qrPromises);
                const content = await zip.generateAsync({type: 'blob'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = `QR_Codes_${new Date().toISOString().split('T')[0]}.zip`;
                link.click();
                
                alert(`Generated ${selectedStudents.length} QR codes and downloaded as ZIP file`);
            } catch (error) {
                alert('Failed to generate bulk QR codes: ' + error.message);
            }
        }

        // Generate custom QR code
        function generateCustomQR() {
            const customData = document.getElementById('custom-data').value.trim();
            
            if (!customData) {
                alert('Please enter custom data');
                return;
            }

            generateQRCode(customData, 'Custom QR Code');
        }

        // Generate QR code using QRCode.js
        async function generateQRCode(data, info) {
            try {
                const canvas = document.getElementById('qr-canvas');
                await QRCode.toCanvas(canvas, data, {
                    width: 300,
                    margin: 2,
                    color: {
                        dark: '#000000',
                        light: '#FFFFFF'
                    }
                });

                currentQRData = data;
                document.getElementById('qr-info').textContent = info;
                document.getElementById('qr-display').style.display = 'block';
                document.getElementById('qr-actions').style.display = 'flex';
                
                // Scroll to QR code
                document.getElementById('qr-display').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                alert('Failed to generate QR code: ' + error.message);
            }
        }

        // Download QR code
        function downloadQR() {
            const canvas = document.getElementById('qr-canvas');
            const link = document.createElement('a');
            link.download = `QR_Code_${new Date().getTime()}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }

        // Print QR code
        function printQR() {
            const canvas = document.getElementById('qr-canvas');
            const windowContent = `
                <html>
                <head><title>QR Code</title></head>
                <body style="text-align: center; padding: 20px;">
                    <h2>${document.getElementById('qr-info').textContent}</h2>
                    <img src="${canvas.toDataURL()}" style="max-width: 400px;">
                    <p>Generated on: ${new Date().toLocaleString()}</p>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '', 'width=600,height=600');
            printWindow.document.open();
            printWindow.document.write(windowContent);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        }

        // Share QR code
        async function shareQR() {
            if (navigator.share) {
                const canvas = document.getElementById('qr-canvas');
                canvas.toBlob(async (blob) => {
                    const file = new File([blob], 'qr-code.png', { type: 'image/png' });
                    try {
                        await navigator.share({
                            title: 'QR Code',
                            text: document.getElementById('qr-info').textContent,
                            files: [file]
                        });
                    } catch (error) {
                        console.log('Error sharing:', error);
                        fallbackShare();
                    }
                });
            } else {
                fallbackShare();
            }
        }

        // Fallback share method
        function fallbackShare() {
            const canvas = document.getElementById('qr-canvas');
            const dataUrl = canvas.toDataURL();
            
            // Copy to clipboard if supported
            if (navigator.clipboard) {
                canvas.toBlob(async (blob) => {
                    try {
                        await navigator.clipboard.write([
                            new ClipboardItem({ 'image/png': blob })
                        ]);
                        alert('QR code copied to clipboard!');
                    } catch (error) {
                        downloadQR(); // Fallback to download
                    }
                });
            } else {
                downloadQR(); // Fallback to download
            }
        }

        // Add JSZip library for bulk download
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
        document.head.appendChild(script);
    </script>
</body>
</html>
